<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - GST Invoice Generator</title>
  <link rel="icon" type="image/png" href="assets/images/logo-fav.png">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <h1>GST Invoice Generator</h1>
      <div class="nav-menu">
        <span id="user-info"></span>
        <button id="logout-btn">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading Dashboard...</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-main" class="dashboard-container" style="display: none;">
    <div class="sidebar">
      <ul class="menu">
        <li><a href="#" class="menu-item active" data-section="saved-invoices">üìã Saved Invoices</a></li>
        <li><a href="#" class="menu-item" data-section="profile-section">‚öôÔ∏è Profile Settings</a></li>
        <li><a href="index.html" class="menu-item">üìÑ Create New Invoice</a></li>
      </ul>
    </div>

    <div class="main-content">
      <!-- Saved Invoices Section -->
      <div id="saved-invoices" class="content-section">
        <h2>Saved Invoices</h2>
        <div class="invoices-actions">
          <button id="refresh-invoices" class="secondary-btn">Refresh</button>
        </div>
        <div id="saved-invoices-list">
          <p>Loading saved invoices...</p>
        </div>
      </div>

      <!-- Profile Settings Section -->
      <div id="profile-section" class="content-section hidden">
        <h2>Profile Settings</h2>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
          <button type="button" class="tab-btn active" data-tab="company-tab">Company Details</button>
          <button type="button" class="tab-btn" data-tab="banking-tab">Banking & Payment</button>
        </div>

        <form id="profile-form">
          <!-- Company Details Tab -->
          <div id="company-tab" class="tab-content active">
            <div class="form-group">
              <label for="display-name">Display Name:</label>
              <input type="text" id="display-name">
            </div>

            <div class="form-group">
              <label for="default-seller-name">Default Seller Name:</label>
              <input type="text" id="default-seller-name">
            </div>

            <div class="form-group">
              <label for="default-seller-address">Default Seller Address:</label>
              <input type="text" id="default-seller-address">
            </div>

            <div class="form-group">
              <label for="default-seller-gst">Default Seller GST:</label>
              <input type="text" id="default-seller-gst">
            </div>

            <div class="form-group">
              <label for="company-logo">Company Logo:</label>
              <input type="file" id="company-logo" accept="image/*">
              <div id="logo-preview" class="logo-preview hidden">
                <img id="logo-preview-img" src="" alt="Logo Preview">
                <button type="button" id="remove-logo" class="remove-logo-btn">Remove Logo</button>
              </div>
            </div>
          </div>

          <!-- Banking Details Tab -->
          <div id="banking-tab" class="tab-content hidden">
            <div class="form-group">
              <label for="bank-name">Bank Name:</label>
              <input type="text" id="bank-name" placeholder="e.g., State Bank of India">
            </div>

            <div class="form-group">
              <label for="account-holder">Account Holder Name:</label>
              <input type="text" id="account-holder" placeholder="Account holder name">
            </div>

            <div class="form-group">
              <label for="account-number">Account Number:</label>
              <input type="text" id="account-number" placeholder="Account number">
            </div>

            <div class="form-group">
              <label for="ifsc-code">IFSC Code:</label>
              <input type="text" id="ifsc-code" placeholder="e.g., SBIN0001234">
            </div>

            <div class="form-group">
              <label for="branch-name">Branch Name:</label>
              <input type="text" id="branch-name" placeholder="Branch name">
            </div>

            <div class="form-group">
              <label for="upi-id">UPI ID:</label>
              <input type="text" id="upi-id" placeholder="e.g., yourname@paytm">
            </div>

            <div class="form-group">
              <label for="upi-qr-code">UPI QR Code:</label>
              <input type="file" id="upi-qr-code" accept="image/*">
              <div id="qr-preview" class="logo-preview hidden">
                <img id="qr-preview-img" src="" alt="QR Code Preview">
                <button type="button" id="remove-qr" class="remove-logo-btn">Remove QR Code</button>
              </div>
            </div>
          </div>

          <button type="submit">Update Profile</button>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { authManager } from './js/auth.js';
    import { invoiceStorage } from './js/invoice-storage.js';

    let savedInvoices = [];

    // Global functions used by inline onclick handlers
    window.viewInvoice = async function (invoiceId) {
      const invoice = savedInvoices.find(inv => inv.id === invoiceId);
      if (invoice) {
        // Open invoice in a new window/modal
        const newWindow = window.open('', '_blank');
        const htmlContent = await generateInvoiceHTML(invoice);
        newWindow.document.write(htmlContent);
        newWindow.document.close();
      }
    };

    window.downloadInvoice = async function (invoiceId) {
      const invoice = savedInvoices.find(inv => inv.id === invoiceId);
      if (invoice) {
        // Use existing PDF generator
        await generateInvoicePDF(invoice);
      }
    };

    window.deleteInvoice = async function (invoiceId) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        const result = await invoiceStorage.deleteInvoice(invoiceId);
        if (result.success) {
          alert('Invoice deleted successfully!');
          loadSavedInvoices(); // Refresh the list
        } else {
          alert('Failed to delete invoice: ' + result.message);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', async function () {
      // Wait for auth state to be determined
      const user = await authManager.waitForAuthState();

      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Hide loading screen and show dashboard
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('dashboard-main').style.display = 'flex';

      // Tab functionality
      initTabFunctionality();

      // Logo and QR code preview functionality
      initImagePreview();

      // Load profile data
      loadProfileData();

      // Profile form submission
      document.getElementById('profile-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        await saveProfileData();
      });

      // Logout functionality
      document.getElementById('logout-btn').addEventListener('click', function () {
        authManager.logout();
      });

      // Load saved invoices when the saved section is opened
      loadSavedInvoices();

      // Refresh invoices button
      document.getElementById('refresh-invoices').addEventListener('click', function () {
        loadSavedInvoices();
      });

      // Sidebar navigation
      const menuItems = document.querySelectorAll('.menu-item');
      const contentSections = document.querySelectorAll('.content-section');

      menuItems.forEach(item => {
        item.addEventListener('click', function (e) {
          // Only prevent default for items with data-section (dashboard tabs)
          // Allow normal navigation for external links like "Create New Invoice"
          const section = this.getAttribute('data-section');
          if (!section) {
            // This is an external link, allow normal navigation
            return;
          }

          e.preventDefault();

          // Remove active class from all items
          menuItems.forEach(mi => mi.classList.remove('active'));
          contentSections.forEach(cs => cs.classList.add('hidden'));

          // Add active class to clicked item
          this.classList.add('active');

          // Show corresponding content section
          const targetSection = document.getElementById(section);
          if (targetSection) {
            targetSection.classList.remove('hidden');

            // If switching to profile section, load the data
            if (section === 'profile-section') {
              loadProfileData();
            }
          }
        });
      });
    });

    async function loadSavedInvoices() {
      const invoicesList = document.getElementById('saved-invoices-list');
      invoicesList.innerHTML = '<p>Loading...</p>';

      const result = await invoiceStorage.getUserInvoices();
      if (result.success && result.invoices.length > 0) {
        savedInvoices = result.invoices;
        let invoicesHtml = '<div class="invoices-grid">';

        result.invoices.forEach(invoice => {
          invoicesHtml += `
            <div class="invoice-card">
              <div class="invoice-header">
                <h3>Invoice #${invoice.invoiceNumber}</h3>
                <span class="invoice-date">${invoice.date}</span>
              </div>
              <div class="invoice-details">
                <p><strong>Buyer:</strong> ${invoice.buyer.name}</p>
                <p><strong>Amount:</strong> ‚Çπ${invoice.totalAmount.toFixed(2)}</p>
              </div>
              <div class="invoice-actions">
                <button class="view-btn" onclick="viewInvoice('${invoice.id}')">View</button>
                <button class="download-btn" onclick="downloadInvoice('${invoice.id}')">Download</button>
                <button class="delete-btn" onclick="deleteInvoice('${invoice.id}')">Delete</button>
              </div>
            </div>
          `;
        });

        invoicesHtml += '</div>';
        invoicesList.innerHTML = invoicesHtml;
      } else if (result.success && result.invoices.length === 0) {
        invoicesList.innerHTML = '<p>No saved invoices found. <a href="index.html">Create your first invoice</a></p>';
      } else {
        invoicesList.innerHTML = '<p>Error loading invoices: ' + result.message + '</p>';
      }
    }

    async function generateInvoiceHTML(invoice) {
      // Get company logo
      const logoUrl = window.authManager ? await window.authManager.getCompanyLogo() : 'assets/images/logo.png';

      let itemsHtml = '';
      invoice.items.forEach(item => {
        itemsHtml += `
          <tr>
            <td>${item.description}</td>
            <td style="text-align: center;">${item.quantity}</td>
            <td style="text-align: right;">‚Çπ${item.price.toFixed(2)}</td>
            <td style="text-align: right;">‚Çπ${item.total.toFixed(2)}</td>
          </tr>
        `;
      });

      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice ${invoice.invoiceNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
            .invoice-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
            .invoice-logo { height: 60px; width: auto; margin-bottom: 10px; }
            .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
            .details-section { padding: 15px; background-color: #f8f9fa; border-radius: 4px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
            th { background-color: #f8f9fa; }
            .totals { text-align: right; margin-top: 20px; }
            .total-row { margin: 5px 0; }
            .final-total { font-weight: bold; font-size: 18px; border-top: 1px solid #333; padding-top: 10px; }
            @media print {
              body { 
                margin: 0; 
                line-height: 1.4 !important;
              }
              table td, table th {
                line-height: 1.4 !important;
                padding: 8px !important;
              }
              div[style*="page-break-inside: avoid"] {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
              }
            }
          </style>
        </head>
        <body>
          <div class="invoice-header">
            <img src="${logoUrl}" alt="Logo" class="invoice-logo">
            <h1>GST INVOICE</h1>
            <p>Invoice Number: ${invoice.invoiceNumber}</p>
            <p>Date: ${invoice.date}</p>
          </div>
          
          <div class="details-grid">
            <div class="details-section">
              <h3>Seller Details:</h3>
              <p><strong>Name:</strong> ${invoice.seller.name}</p>
              ${invoice.seller.address ? `<p><strong>Address:</strong> ${invoice.seller.address}</p>` : ''}
              ${invoice.seller.gst ? `<p><strong>GST Number:</strong> ${invoice.seller.gst}</p>` : ''}
            </div>
            <div class="details-section">
              <h3>Buyer Details:</h3>
              <p><strong>Name:</strong> ${invoice.buyer.name}</p>
              ${invoice.buyer.address ? `<p><strong>Address:</strong> ${invoice.buyer.address}</p>` : ''}
              ${invoice.buyer.gst ? `<p><strong>GST Number:</strong> ${invoice.buyer.gst}</p>` : ''}
            </div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: center;">Quantity</th>
                <th style="text-align: right;">Unit Price</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>
          
          <div class="totals">
            <div class="total-row">Subtotal: ‚Çπ${invoice.subtotal.toFixed(2)}</div>
            <div class="total-row">CGST (2.5%): ‚Çπ${invoice.cgstAmount.toFixed(2)}</div>
            <div class="total-row">SGST (2.5%): ‚Çπ${invoice.sgstAmount.toFixed(2)}</div>
            <div class="total-row final-total">Grand Total: ‚Çπ${invoice.totalAmount.toFixed(2)}</div>
          </div>
          
          ${await getBankingDetailsHTML()}
        </body>
        </html>
      `;
    }

    async function getBankingDetailsHTML() {
      try {
        if (!authManager.currentUser) return '';

        const profile = await authManager.getUserProfile(authManager.currentUser.uid);
        if (!profile?.banking && !profile?.upiQrCode) return '';

        let bankingHtml = '<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;"><h3>Payment Details:</h3>';

        if (profile.banking) {
          const banking = profile.banking;
          bankingHtml += '<div style="margin-bottom: 15px;">';
          if (banking.bankName) bankingHtml += `<p><strong>Bank:</strong> ${banking.bankName}</p>`;
          if (banking.accountHolder) bankingHtml += `<p><strong>Account Holder:</strong> ${banking.accountHolder}</p>`;
          if (banking.accountNumber) bankingHtml += `<p><strong>Account Number:</strong> ${banking.accountNumber}</p>`;
          if (banking.ifscCode) bankingHtml += `<p><strong>IFSC Code:</strong> ${banking.ifscCode}</p>`;
          if (banking.branchName) bankingHtml += `<p><strong>Branch:</strong> ${banking.branchName}</p>`;
          if (banking.upiId) bankingHtml += `<p><strong>UPI ID:</strong> ${banking.upiId}</p>`;
          bankingHtml += '</div>';
        }

        if (profile.upiQrCode) {
          bankingHtml += `<div style="text-align: center; margin-top: 15px; page-break-inside: avoid;">
            <p style="margin-bottom: 8px;"><strong>UPI QR Code:</strong></p>
            <img src="${profile.upiQrCode}" alt="UPI QR Code" style="height: 100px; width: 100px; display: inline-block;">
          </div>`;
        }

        bankingHtml += '</div>';
        return bankingHtml;
      } catch (error) {
        console.error('Error getting banking details:', error);
        return '';
      }
    }

    async function generateInvoicePDF(invoice) {
      const printWindow = window.open('', '_blank');
      const htmlContent = await generateInvoiceHTML(invoice);
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.onload = function () {
        setTimeout(function () {
          printWindow.print();
        }, 500);
      };
    }

    function initTabFunctionality() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          const targetTab = this.getAttribute('data-tab');

          // Remove active class from all tabs and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });
    }

    function initImagePreview() {
      // Logo upload handling
      document.getElementById('company-logo').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const logoPreview = document.getElementById('logo-preview');
            const logoImg = document.getElementById('logo-preview-img');
            logoImg.src = e.target.result;
            logoPreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove logo functionality
      document.getElementById('remove-logo').addEventListener('click', function () {
        document.getElementById('company-logo').value = '';
        document.getElementById('logo-preview').classList.add('hidden');
        document.getElementById('logo-preview-img').src = '';
      });

      // QR code upload handling
      document.getElementById('upi-qr-code').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const qrPreview = document.getElementById('qr-preview');
            const qrImg = document.getElementById('qr-preview-img');
            qrImg.src = e.target.result;
            qrPreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove QR code functionality
      document.getElementById('remove-qr').addEventListener('click', function () {
        document.getElementById('upi-qr-code').value = '';
        document.getElementById('qr-preview').classList.add('hidden');
        document.getElementById('qr-preview-img').src = '';
      });
    }

    // Profile management functions
    async function loadProfileData() {
      if (!authManager.currentUser) return;

      try {
        const profile = await authManager.getUserProfile(authManager.currentUser.uid);
        if (profile) {
          document.getElementById('display-name').value = profile.displayName || '';
          document.getElementById('default-seller-name').value = profile.defaultSellerName || '';
          document.getElementById('default-seller-address').value = profile.defaultSellerAddress || '';
          document.getElementById('default-seller-gst').value = profile.defaultSellerGst || '';

          // Load company logo if exists
          if (profile.companyLogo) {
            const logoPreview = document.getElementById('logo-preview');
            const logoImg = document.getElementById('logo-preview-img');
            logoImg.src = profile.companyLogo;
            logoPreview.classList.remove('hidden');
          }

          // Load banking details
          if (profile.banking) {
            document.getElementById('bank-name').value = profile.banking.bankName || '';
            document.getElementById('account-holder').value = profile.banking.accountHolder || '';
            document.getElementById('account-number').value = profile.banking.accountNumber || '';
            document.getElementById('ifsc-code').value = profile.banking.ifscCode || '';
            document.getElementById('branch-name').value = profile.banking.branchName || '';
            document.getElementById('upi-id').value = profile.banking.upiId || '';
          }

          // Load UPI QR code if exists
          if (profile.upiQrCode) {
            const qrPreview = document.getElementById('qr-preview');
            const qrImg = document.getElementById('qr-preview-img');
            qrImg.src = profile.upiQrCode;
            qrPreview.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    async function saveProfileData() {
      if (!authManager.currentUser) return;

      const profileData = {
        displayName: document.getElementById('display-name').value,
        defaultSellerName: document.getElementById('default-seller-name').value,
        defaultSellerAddress: document.getElementById('default-seller-address').value,
        defaultSellerGst: document.getElementById('default-seller-gst').value,
        email: authManager.currentUser.email,
        updatedAt: new Date().toISOString()
      };

      // Banking details
      const bankingData = {
        bankName: document.getElementById('bank-name').value,
        accountHolder: document.getElementById('account-holder').value,
        accountNumber: document.getElementById('account-number').value,
        ifscCode: document.getElementById('ifsc-code').value,
        branchName: document.getElementById('branch-name').value,
        upiId: document.getElementById('upi-id').value
      };

      // Add banking details if any field is filled
      if (Object.values(bankingData).some(value => value.trim() !== '')) {
        profileData.banking = bankingData;
      }

      // Include company logo if uploaded
      const logoImg = document.getElementById('logo-preview-img');
      if (logoImg.src && !logoImg.src.includes('assets/images/')) {
        profileData.companyLogo = logoImg.src;
      }

      // Include UPI QR code if uploaded
      const qrImg = document.getElementById('qr-preview-img');
      if (qrImg.src && qrImg.src.trim() !== '') {
        profileData.upiQrCode = qrImg.src;
      }

      try {
        await authManager.createUserProfile(authManager.currentUser.uid, profileData);
        alert('Profile updated successfully!');
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error saving profile: ' + error.message);
      }
    }
  </script>
</body>

</html>