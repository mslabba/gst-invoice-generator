<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - GST Invoice Generator</title>
  <link rel="icon" type="image/png" href="assets/images/logo-fav.png">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <style>
    /* Invoice form specific styles */
    #create-invoice-section {
      max-height: 80vh;
      overflow-y: auto;
    }

    #create-invoice-section .form-group {
      margin-bottom: 15px;
    }

    #create-invoice-section .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    #create-invoice-section .form-group input,
    #create-invoice-section .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #create-invoice-section h3 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
      margin: 20px 0 15px 0;
    }

    .seller-buyer-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 20px;
    }

    .seller-section,
    .buyer-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    @media (max-width: 768px) {
      .seller-buyer-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .item-row {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9f9f9;
    }

    .item-fields {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .totals-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .grand-total {
      font-weight: bold;
      font-size: 1.1em;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .action-buttons button {
      flex: 1;
    }

    .secondary-btn {
      background-color: #6c757d !important;
      color: white !important;
    }

    .secondary-btn:hover {
      background-color: #5a6268 !important;
    }

    .form-group small {
      display: block;
      margin-top: 3px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .item-fields {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .action-buttons button {
        margin-bottom: 10px;
      }
    }

    /* Stock Management Styles */
    .stock-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }

    .stock-tabs .tab-btn {
      background: none;
      border: none;
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.3s ease;
    }

    .stock-tabs .tab-btn.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .stock-tabs .tab-btn:hover {
      color: #2980b9;
      background-color: #f8f9fa;
    }

    .products-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .product-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .product-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c3e50;
      margin: 0;
    }

    .stock-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .stock-badge.in-stock {
      background-color: #d4edda;
      color: #155724;
    }

    .stock-badge.low-stock {
      background-color: #fff3cd;
      color: #856404;
    }

    .stock-badge.out-of-stock {
      background-color: #f8d7da;
      color: #721c24;
    }

    .product-details {
      margin-bottom: 15px;
    }

    .product-details p {
      margin: 5px 0;
      color: #6c757d;
      font-size: 0.9em;
    }

    .product-actions {
      display: flex;
      gap: 5px;
    }

    .product-actions button {
      flex: 1;
      padding: 6px 12px;
      font-size: 0.8em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .edit-product-btn {
      background-color: #17a2b8;
      color: white;
    }

    .edit-product-btn:hover {
      background-color: #138496;
    }

    .delete-product-btn {
      background-color: #dc3545;
      color: white;
    }

    .delete-product-btn:hover {
      background-color: #c82333;
    }

    .update-stock-btn {
      background-color: #28a745;
      color: white;
    }

    .update-stock-btn:hover {
      background-color: #218838;
    }

    .item-fields {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .stock-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-top: 5px;
    }

    .stock-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-top: 5px;
    }

    /* Navbar styles */
    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .navbar-logo {
      height: 40px;
      width: auto;
      border-radius: 4px;
    }

    .nav-container h1 {
      color: #ecf0f1;
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: 1fr;
      }

      .products-actions {
        flex-direction: column;
      }

      .stock-tabs {
        flex-direction: column;
      }

      .item-fields {
        grid-template-columns: 1fr;
      }

      .nav-brand {
        gap: 8px;
      }

      .nav-container h1 {
        font-size: 1.2rem;
      }

      .navbar-logo {
        height: 32px;
      }
    }

    /* Credits section styles */
    .credits-section {
      background: #34495e;
      color: #ecf0f1;
      padding: 20px 0;
      text-align: center;
      border-top: 3px solid #3498db;
    }

    .credits-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .credits-logo {
      height: 32px;
      width: auto;
      opacity: 0.9;
    }

    .credits-text {
      font-size: 0.9rem;
      margin: 0;
      opacity: 0.9;
    }

    .credits-text a {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }

    .credits-text a:hover {
      color: #5dade2;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .credits-container {
        flex-direction: column;
        gap: 10px;
      }

      .credits-logo {
        height: 28px;
      }

      .credits-text {
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <img id="navbar-logo" src="assets/images/logo-fav.png" alt="Logo" class="navbar-logo">
        <h1>GST Invoice Generator</h1>
      </div>
      <div class="nav-menu">
        <span id="user-info"></span>
        <button id="logout-btn">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading Dashboard...</p>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-main" class="dashboard-container" style="display: none;">
    <div class="sidebar">
      <ul class="menu">
        <li><a href="#" class="menu-item active" data-section="saved-invoices">üìã Saved Invoices</a></li>
        <li><a href="#" class="menu-item" data-section="stock-management-section">üì¶ Stock Management</a></li>
        <li><a href="#" class="menu-item" data-section="profile-section">‚öôÔ∏è Profile Settings</a></li>
        <li><a href="#" class="menu-item" data-section="create-invoice-section">üìÑ Create New Invoice</a></li>
      </ul>
    </div>

    <div class="main-content">
      <!-- Saved Invoices Section -->
      <div id="saved-invoices" class="content-section">
        <h2>Saved Invoices</h2>
        <div class="invoices-actions">
          <button id="refresh-invoices" class="secondary-btn">Refresh</button>
        </div>
        <div id="saved-invoices-list">
          <p>Loading saved invoices...</p>
        </div>
      </div>

      <!-- Stock Management Section -->
      <div id="stock-management-section" class="content-section hidden">
        <h2>Stock Management</h2>

        <!-- Stock Tabs -->
        <div class="stock-tabs">
          <button type="button" class="tab-btn active" data-tab="products-tab">Products</button>
          <button type="button" class="tab-btn" data-tab="add-product-tab">Add Product</button>
        </div>

        <!-- Products List Tab -->
        <div id="products-tab" class="tab-content active">
          <div class="products-actions">
            <button id="refresh-products" class="secondary-btn">Refresh</button>
            <button id="export-products" class="secondary-btn">Export</button>
          </div>
          <div id="products-list">
            <p>Loading products...</p>
          </div>
        </div>

        <!-- Add Product Tab -->
        <div id="add-product-tab" class="tab-content">
          <form id="product-form">
            <div class="form-group">
              <label for="product-name">Product Name:</label>
              <input type="text" id="product-name" required>
            </div>

            <div class="form-group">
              <label for="product-description">Description:</label>
              <textarea id="product-description" rows="3" placeholder="Optional product description"></textarea>
            </div>

            <div class="form-group">
              <label for="product-hsn">HSN Code:</label>
              <input type="text" id="product-hsn" placeholder="Optional HSN code">
            </div>

            <div class="seller-buyer-container">
              <div class="seller-section">
                <div class="form-group">
                  <label for="product-price">Unit Price (‚Çπ):</label>
                  <input type="number" id="product-price" min="0" step="0.01" required>
                </div>
              </div>
              <div class="buyer-section">
                <div class="form-group">
                  <label for="product-stock">Stock Quantity:</label>
                  <input type="number" id="product-stock" min="0" step="1" required>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="product-unit">Unit of Measurement:</label>
              <select id="product-unit" required>
                <option value="">Select Unit</option>
                <option value="pcs">Pieces</option>
                <option value="kg">Kilograms</option>
                <option value="grams">Grams</option>
                <option value="liters">Liters</option>
                <option value="meters">Meters</option>
                <option value="boxes">Boxes</option>
                <option value="sets">Sets</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="product-category">Category:</label>
              <input type="text" id="product-category" placeholder="Optional category">
            </div>

            <button type="submit">Add Product</button>
          </form>
        </div>
      </div>

      <!-- Profile Settings Section -->
      <div id="profile-section" class="content-section hidden">
        <h2>Profile Settings</h2>

        <!-- Profile Tabs -->
        <div class="profile-tabs">
          <button type="button" class="tab-btn active" data-tab="company-tab">Company Details</button>
          <button type="button" class="tab-btn" data-tab="banking-tab">Banking & Payment</button>
        </div>

        <form id="profile-form">
          <!-- Company Details Tab -->
          <div id="company-tab" class="tab-content active">
            <div class="form-group">
              <label for="display-name">Display Name:</label>
              <input type="text" id="display-name">
            </div>

            <div class="form-group">
              <label for="default-seller-name">Default Seller Name:</label>
              <input type="text" id="default-seller-name">
            </div>

            <div class="form-group">
              <label for="default-seller-address">Default Seller Address:</label>
              <input type="text" id="default-seller-address">
            </div>

            <div class="form-group">
              <label for="default-seller-gst">Default Seller GST:</label>
              <input type="text" id="default-seller-gst">
            </div>

            <div class="form-group">
              <label for="company-logo">Company Logo:</label>
              <input type="file" id="company-logo" accept="image/*">
              <div id="logo-preview" class="logo-preview hidden">
                <img id="logo-preview-img" src="" alt="Logo Preview">
                <button type="button" id="remove-logo" class="remove-logo-btn">Remove Logo</button>
              </div>
            </div>
          </div>

          <!-- Banking Details Tab -->
          <div id="banking-tab" class="tab-content">
            <div class="form-group">
              <label for="bank-name">Bank Name:</label>
              <input type="text" id="bank-name" placeholder="e.g., State Bank of India">
            </div>

            <div class="form-group">
              <label for="account-holder">Account Holder Name:</label>
              <input type="text" id="account-holder" placeholder="Account holder name">
            </div>

            <div class="form-group">
              <label for="account-number">Account Number:</label>
              <input type="text" id="account-number" placeholder="Account number">
            </div>

            <div class="form-group">
              <label for="ifsc-code">IFSC Code:</label>
              <input type="text" id="ifsc-code" placeholder="e.g., SBIN0001234">
            </div>

            <div class="form-group">
              <label for="branch-name">Branch Name:</label>
              <input type="text" id="branch-name" placeholder="Branch name">
            </div>

            <div class="form-group">
              <label for="upi-id">UPI ID:</label>
              <input type="text" id="upi-id" placeholder="e.g., yourname@paytm">
            </div>

            <div class="form-group">
              <label for="upi-qr-code">UPI QR Code:</label>
              <input type="file" id="upi-qr-code" accept="image/*">
              <div id="qr-preview" class="logo-preview hidden">
                <img id="qr-preview-img" src="" alt="QR Code Preview">
                <button type="button" id="remove-qr" class="remove-logo-btn">Remove QR Code</button>
              </div>
            </div>
          </div>

          <button type="submit">Update Profile</button>
        </form>
      </div>

      <!-- Create Invoice Section -->
      <div id="create-invoice-section" class="content-section hidden">
        <h2>Create New Invoice</h2>

        <form id="invoice-form">
          <div class="seller-buyer-container">
            <div class="seller-section">
              <h3>Seller Details</h3>
              <div class="form-group">
                <label for="seller-name">Seller Name:</label>
                <input type="text" id="seller-name" required>
              </div>

              <div class="form-group">
                <label for="seller-address">Seller Address:</label>
                <input type="text" id="seller-address" placeholder="Optional">
              </div>

              <div class="form-group">
                <label for="seller-gst">Seller GST Number:</label>
                <input type="text" id="seller-gst" placeholder="Optional (e.g., 22AAAAA0000A1Z5)">
              </div>
            </div>

            <div class="buyer-section">
              <h3>Buyer Details</h3>
              <div class="buyer-selection form-group">
                <label for="buyer-select">Select Existing Buyer (Optional):</label>
                <select id="buyer-select">
                  <option value="">-- Select a buyer or enter new details --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="buyer-name">Buyer Name:</label>
                <input type="text" id="buyer-name" required>
              </div>

              <div class="form-group">
                <label for="buyer-address">Buyer Address:</label>
                <input type="text" id="buyer-address" placeholder="Optional">
              </div>

              <div class="form-group">
                <label for="buyer-gst">Buyer GST Number:</label>
                <input type="text" id="buyer-gst" placeholder="Optional (e.g., 22AAAAA0000A1Z5)">
              </div>
            </div>
          </div>

          <h3>Invoice Details</h3>
          <div class="seller-buyer-container">
            <div class="seller-section">
              <div class="form-group">
                <label for="invoice-number">Invoice Number:</label>
                <input type="text" id="invoice-number" placeholder="Auto-generated" value="">
                <small style="color: #666;">Leave blank for auto-generation</small>
              </div>
            </div>
            <div class="buyer-section">
              <div class="form-group">
                <label for="invoice-date">Invoice Date:</label>
                <input type="date" id="invoice-date" required>
              </div>
            </div>
          </div>

          <h3>Invoice Items</h3>
          <div id="items-container">
            <div class="item-row" data-index="0">
              <div class="item-fields">
                <div class="field-group">
                  <label>Select Product (Optional):</label>
                  <select class="product-select">
                    <option value="">-- Select from inventory or enter manually --</option>
                  </select>
                </div>
                <div class="field-group">
                  <label>Item Description:</label>
                  <input type="text" class="item-description" placeholder="Enter item description" required>
                </div>
                <div class="field-group">
                  <label>HSN Code:</label>
                  <input type="text" class="item-hsn" placeholder="HSN Code (Optional)">
                </div>
                <div class="field-group">
                  <label>Quantity:</label>
                  <input type="number" class="item-quantity" min="1" step="0.01" placeholder="1" required>
                </div>
                <div class="field-group">
                  <label>Unit Price (‚Çπ):</label>
                  <input type="number" class="item-price" min="0" step="0.01" placeholder="0.00" required>
                </div>
                <div class="field-group">
                  <label>Total (‚Çπ):</label>
                  <input type="number" class="item-total" readonly>
                </div>
                <div class="field-group">
                  <button type="button" class="remove-item-btn" onclick="removeItem(0)">Remove</button>
                </div>
              </div>
            </div>
          </div>

          <button type="button" id="add-item-btn">Add Item</button>

          <div class="totals-section">
            <div class="total-row">
              <span>Subtotal:</span>
              <span id="subtotal-display">‚Çπ0.00</span>
            </div>
            <div class="total-row">
              <span>GST (2.5%):</span>
              <span id="gst-display">‚Çπ0.00</span>
            </div>
            <div class="total-row grand-total">
              <span>Grand Total:</span>
              <span id="grand-total-display">‚Çπ0.00</span>
            </div>
          </div>

          <button type="button" id="generate-invoice">Generate Invoice</button>
        </form>

        <div id="invoice-output" class="hidden">
          <div id="invoice-details"></div>
          <div class="action-buttons">
            <button id="download-pdf">Download PDF & Save</button>
            <button id="new-invoice-btn" class="secondary-btn">Start New Invoice</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Credits Section -->
  <div class="credits-section">
    <div class="credits-container">
      <img src="assets/images/logo.png" alt="Turgut Logo" class="credits-logo">
      <p class="credits-text">
        Powered by <a href="#" target="_blank">Turgut</a> ‚Ä¢ GST Invoice Generator
      </p>
    </div>
  </div>

  <!-- Add invoice-related scripts -->
  <script src="js/invoice.js"></script>
  <script src="js/pdf-generator.js"></script>

  <script type="module">
    import { authManager } from './js/auth.js';
    import { invoiceStorage } from './js/invoice-storage.js';
    import { buyerStorage } from './js/buyer-storage.js';
    import { stockManager } from './js/stock-management.js';

    let savedInvoices = [];

    // Global functions used by inline onclick handlers
    window.viewInvoice = async function (invoiceId) {
      const invoice = savedInvoices.find(inv => inv.id === invoiceId);
      if (invoice) {
        // Open invoice in a new window/modal
        const newWindow = window.open('', '_blank');
        const htmlContent = await generateInvoiceHTML(invoice);
        newWindow.document.write(htmlContent);
        newWindow.document.close();
      }
    };

    window.downloadInvoice = async function (invoiceId) {
      const invoice = savedInvoices.find(inv => inv.id === invoiceId);
      if (invoice) {
        // Use existing PDF generator
        await generateInvoicePDF(invoice);
      }
    };

    window.deleteInvoice = async function (invoiceId) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        const result = await invoiceStorage.deleteInvoice(invoiceId);
        if (result.success) {
          alert('Invoice deleted successfully!');
          loadSavedInvoices(); // Refresh the list
        } else {
          alert('Failed to delete invoice: ' + result.message);
        }
      }
    };

    document.addEventListener('DOMContentLoaded', async function () {
      // Wait for auth state to be determined
      const user = await authManager.waitForAuthState();

      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Hide loading screen and show dashboard
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('dashboard-main').style.display = 'flex';

      // Load navbar logo
      await loadNavbarLogo();

      // Tab functionality
      initTabFunctionality();

      // Logo and QR code preview functionality
      initImagePreview();

      // Load profile data
      loadProfileData();

      // Profile form submission
      document.getElementById('profile-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        await saveProfileData();
      });

      // Logout functionality
      document.getElementById('logout-btn').addEventListener('click', function () {
        authManager.logout();
      });

      // Load saved invoices when the saved section is opened
      loadSavedInvoices();

      // Refresh invoices button
      document.getElementById('refresh-invoices').addEventListener('click', function () {
        loadSavedInvoices();
      });

      // Initialize stock management
      initStockManagement();

      // Sidebar navigation
      const menuItems = document.querySelectorAll('.menu-item');
      const contentSections = document.querySelectorAll('.content-section');

      menuItems.forEach(item => {
        item.addEventListener('click', function (e) {
          // Only prevent default for items with data-section (dashboard tabs)
          // Allow normal navigation for external links like "Create New Invoice"
          const section = this.getAttribute('data-section');
          if (!section) {
            // This is an external link, allow normal navigation
            return;
          }

          e.preventDefault();

          // Remove active class from all items
          menuItems.forEach(mi => mi.classList.remove('active'));
          contentSections.forEach(cs => cs.classList.add('hidden'));

          // Add active class to clicked item
          this.classList.add('active');

          // Show corresponding content section
          const targetSection = document.getElementById(section);
          if (targetSection) {
            targetSection.classList.remove('hidden');

            // If switching to profile section, load the data
            if (section === 'profile-section') {
              loadProfileData();
            }

            // If switching to stock management, load products
            if (section === 'stock-management-section') {
              loadProducts();
            }

            // If switching to create invoice, load products for dropdowns
            if (section === 'create-invoice-section') {
              setTimeout(() => {
                initializeInvoiceForm();
                loadProductsInDropdowns();
              }, 100);
            }
          }
        });
      });
    });

    // Function to load company logo in navbar
    async function loadNavbarLogo() {
      try {
        if (authManager && authManager.currentUser) {
          const companyLogo = await authManager.getCompanyLogo();
          const navbarLogo = document.getElementById('navbar-logo');
          if (navbarLogo && companyLogo && companyLogo !== 'assets/images/logo.png') {
            navbarLogo.src = companyLogo;
          }
        }
      } catch (error) {
        console.error('Error loading navbar logo:', error);
      }
    }

    async function loadSavedInvoices() {
      const invoicesList = document.getElementById('saved-invoices-list');
      invoicesList.innerHTML = '<p>Loading...</p>';

      const result = await invoiceStorage.getUserInvoices();
      if (result.success && result.invoices.length > 0) {
        savedInvoices = result.invoices;
        let invoicesHtml = '<div class="invoices-grid">';

        result.invoices.forEach(invoice => {
          invoicesHtml += `
            <div class="invoice-card">
              <div class="invoice-header">
                <h3>Invoice #${invoice.invoiceNumber}</h3>
                <span class="invoice-date">${invoice.date}</span>
              </div>
              <div class="invoice-details">
                <p><strong>Buyer:</strong> ${invoice.buyer ? invoice.buyer.name : 'N/A'}</p>
                <p><strong>Amount:</strong> ‚Çπ${(invoice.totalAmount || 0).toFixed(2)}</p>
              </div>
              <div class="invoice-actions">
                <button class="view-btn" onclick="viewInvoice('${invoice.id}')">View</button>
                <button class="download-btn" onclick="downloadInvoice('${invoice.id}')">Download</button>
                <button class="delete-btn" onclick="deleteInvoice('${invoice.id}')">Delete</button>
              </div>
            </div>
          `;
        });

        invoicesHtml += '</div>';
        invoicesList.innerHTML = invoicesHtml;
      } else if (result.success && result.invoices.length === 0) {
        invoicesList.innerHTML = '<p>No saved invoices found. <a href="#" onclick="switchToCreateInvoice()">Create your first invoice</a></p>';
      } else {
        invoicesList.innerHTML = '<p>Error loading invoices: ' + result.message + '</p>';
      }
    }

    async function generateInvoiceHTML(invoice) {
      // Get company logo
      const logoUrl = window.authManager ? await window.authManager.getCompanyLogo() : 'assets/images/logo.png';

      let itemsHtml = '';
      invoice.items.forEach(item => {
        itemsHtml += `
          <tr>
            <td>${item.description}${item.hsn ? `<br><small style="color: #666;">HSN: ${item.hsn}</small>` : ''}</td>
            <td style="text-align: center;">${item.quantity}</td>
            <td style="text-align: right;">‚Çπ${item.price.toFixed(2)}</td>
            <td style="text-align: right;">‚Çπ${item.total.toFixed(2)}</td>
          </tr>
        `;
      });

      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice ${invoice.invoiceNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.2; font-size: 14px; }
            .invoice-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
            .invoice-logo { height: 45px; width: auto; margin-bottom: 8px; }
            .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .details-section { padding: 10px; background-color: #f8f9fa; border-radius: 4px; }
            .details-section h3 { margin: 0 0 8px 0; font-size: 14px; }
            .details-section p { margin: 3px 0; font-size: 12px; }
            table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            th, td { padding: 6px 8px; text-align: left; border: 1px solid #ddd; font-size: 12px; }
            th { background-color: #f8f9fa; font-weight: bold; }
            .totals { text-align: right; margin-top: 15px; }
            .total-row { margin: 2px 0; font-size: 12px; }
            .final-total { font-weight: bold; font-size: 14px; border-top: 1px solid #333; padding-top: 5px; margin-top: 5px; }
            .payment-details { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
            .payment-details h3 { margin: 0 0 8px 0; font-size: 14px; }
            .payment-details p { margin: 2px 0; font-size: 11px; }
            .payment-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; align-items: start; }
            .qr-section { text-align: center; }
            .qr-section p { margin-bottom: 5px; font-size: 11px; }
            .qr-section img { height: 80px; width: 80px; }
            @media print {
              body { 
                margin: 10px !important; 
                line-height: 1.2 !important;
                font-size: 14px !important;
              }
              .invoice-header { padding-bottom: 10px !important; margin-bottom: 15px !important; }
              .details-grid { margin-bottom: 15px !important; gap: 15px !important; }
              .details-section { padding: 8px !important; }
              table { margin: 10px 0 !important; }
              th, td {
                line-height: 1.2 !important;
                padding: 4px 6px !important;
                font-size: 11px !important;
              }
              .totals { margin-top: 10px !important; }
              .payment-details { margin-top: 10px !important; padding-top: 10px !important; }
              .qr-section img { height: 70px !important; width: 70px !important; }
              div[style*="page-break-inside: avoid"] {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
              }
            }
          </style>
        </head>
        <body>
          <div class="invoice-header">
            <img src="${logoUrl}" alt="Logo" class="invoice-logo">
            <h1>GST INVOICE</h1>
            <p>Invoice Number: ${invoice.invoiceNumber}</p>
            <p>Date: ${invoice.date}</p>
          </div>
          
          <div class="details-grid">
            <div class="details-section">
              <h3>Seller Details:</h3>
              <p><strong>Name:</strong> ${invoice.seller.name}</p>
              ${invoice.seller.address ? `<p><strong>Address:</strong> ${invoice.seller.address}</p>` : ''}
              ${invoice.seller.gst ? `<p><strong>GST Number:</strong> ${invoice.seller.gst}</p>` : ''}
            </div>
            <div class="details-section">
              <h3>Buyer Details:</h3>
              <p><strong>Name:</strong> ${invoice.buyer ? invoice.buyer.name || 'N/A' : 'N/A'}</p>
              ${invoice.buyer && invoice.buyer.address ? `<p><strong>Address:</strong> ${invoice.buyer.address}</p>` : ''}
              ${invoice.buyer && invoice.buyer.gst ? `<p><strong>GST Number:</strong> ${invoice.buyer.gst}</p>` : ''}
            </div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: center;">Quantity</th>
                <th style="text-align: right;">Unit Price</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>
          
          <div class="totals">
            <div class="total-row">Subtotal: ‚Çπ${(invoice.subtotal || 0).toFixed(2)}</div>
            <div class="total-row">CGST (2.5%): ‚Çπ${(invoice.cgstAmount || 0).toFixed(2)}</div>
            <div class="total-row">SGST (2.5%): ‚Çπ${(invoice.sgstAmount || 0).toFixed(2)}</div>
            <div class="total-row final-total">Grand Total: ‚Çπ${(invoice.totalAmount || 0).toFixed(2)}</div>
          </div>
          
          ${await getBankingDetailsHTML()}
        </body>
        </html>
      `;
    }

    async function getBankingDetailsHTML() {
      try {
        if (!authManager.currentUser) return '';

        const profile = await authManager.getUserProfile(authManager.currentUser.uid);
        if (!profile?.banking && !profile?.upiQrCode) return '';

        let bankingHtml = '<div class="payment-details"><h3>Payment Details:</h3>';

        // Use grid layout to optimize space
        bankingHtml += '<div class="payment-grid">';

        if (profile.banking) {
          const banking = profile.banking;
          bankingHtml += '<div class="banking-info">';
          if (banking.bankName) bankingHtml += `<p><strong>Bank:</strong> ${banking.bankName}</p>`;
          if (banking.accountHolder) bankingHtml += `<p><strong>Account Holder:</strong> ${banking.accountHolder}</p>`;
          if (banking.accountNumber) bankingHtml += `<p><strong>Account Number:</strong> ${banking.accountNumber}</p>`;
          if (banking.ifscCode) bankingHtml += `<p><strong>IFSC Code:</strong> ${banking.ifscCode}</p>`;
          if (banking.branchName) bankingHtml += `<p><strong>Branch:</strong> ${banking.branchName}</p>`;
          if (banking.upiId) bankingHtml += `<p><strong>UPI ID:</strong> ${banking.upiId}</p>`;
          bankingHtml += '</div>';
        } else {
          bankingHtml += '<div class="banking-info"></div>';
        }

        if (profile.upiQrCode) {
          bankingHtml += `<div class="qr-section" style="page-break-inside: avoid;">
            <p><strong>UPI QR Code:</strong></p>
            <img src="${profile.upiQrCode}" alt="UPI QR Code">
          </div>`;
        } else {
          bankingHtml += '<div class="qr-section"></div>';
        }

        bankingHtml += '</div></div>';
        return bankingHtml;
      } catch (error) {
        console.error('Error getting banking details:', error);
        return '';
      }
    }

    async function generateInvoicePDF(invoice) {
      const printWindow = window.open('', '_blank');
      const htmlContent = await generateInvoiceHTML(invoice);
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.onload = function () {
        setTimeout(function () {
          printWindow.print();
        }, 500);
      };
    }

    function initTabFunctionality() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          const targetTab = this.getAttribute('data-tab');

          // Remove active class from all tabs and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });
    }

    function initImagePreview() {
      // Logo upload handling
      document.getElementById('company-logo').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const logoPreview = document.getElementById('logo-preview');
            const logoImg = document.getElementById('logo-preview-img');
            logoImg.src = e.target.result;
            logoPreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove logo functionality
      document.getElementById('remove-logo').addEventListener('click', function () {
        document.getElementById('company-logo').value = '';
        document.getElementById('logo-preview').classList.add('hidden');
        document.getElementById('logo-preview-img').src = '';
      });

      // QR code upload handling
      document.getElementById('upi-qr-code').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const qrPreview = document.getElementById('qr-preview');
            const qrImg = document.getElementById('qr-preview-img');
            qrImg.src = e.target.result;
            qrPreview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      // Remove QR code functionality
      document.getElementById('remove-qr').addEventListener('click', function () {
        document.getElementById('upi-qr-code').value = '';
        document.getElementById('qr-preview').classList.add('hidden');
        document.getElementById('qr-preview-img').src = '';
      });
    }

    // Profile management functions
    async function loadProfileData() {
      if (!authManager.currentUser) return;

      try {
        const profile = await authManager.getUserProfile(authManager.currentUser.uid);
        if (profile) {
          document.getElementById('display-name').value = profile.displayName || '';
          document.getElementById('default-seller-name').value = profile.defaultSellerName || '';
          document.getElementById('default-seller-address').value = profile.defaultSellerAddress || '';
          document.getElementById('default-seller-gst').value = profile.defaultSellerGst || '';

          // Load company logo if exists
          if (profile.companyLogo) {
            const logoPreview = document.getElementById('logo-preview');
            const logoImg = document.getElementById('logo-preview-img');
            logoImg.src = profile.companyLogo;
            logoPreview.classList.remove('hidden');
          }

          // Load banking details
          if (profile.banking) {
            document.getElementById('bank-name').value = profile.banking.bankName || '';
            document.getElementById('account-holder').value = profile.banking.accountHolder || '';
            document.getElementById('account-number').value = profile.banking.accountNumber || '';
            document.getElementById('ifsc-code').value = profile.banking.ifscCode || '';
            document.getElementById('branch-name').value = profile.banking.branchName || '';
            document.getElementById('upi-id').value = profile.banking.upiId || '';
          }

          // Load UPI QR code if exists
          if (profile.upiQrCode) {
            const qrPreview = document.getElementById('qr-preview');
            const qrImg = document.getElementById('qr-preview-img');
            qrImg.src = profile.upiQrCode;
            qrPreview.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    async function saveProfileData() {
      if (!authManager.currentUser) return;

      const profileData = {
        displayName: document.getElementById('display-name').value,
        defaultSellerName: document.getElementById('default-seller-name').value,
        defaultSellerAddress: document.getElementById('default-seller-address').value,
        defaultSellerGst: document.getElementById('default-seller-gst').value,
        email: authManager.currentUser.email,
        updatedAt: new Date().toISOString()
      };

      // Banking details
      const bankingData = {
        bankName: document.getElementById('bank-name').value,
        accountHolder: document.getElementById('account-holder').value,
        accountNumber: document.getElementById('account-number').value,
        ifscCode: document.getElementById('ifsc-code').value,
        branchName: document.getElementById('branch-name').value,
        upiId: document.getElementById('upi-id').value
      };

      // Add banking details if any field is filled
      if (Object.values(bankingData).some(value => value.trim() !== '')) {
        profileData.banking = bankingData;
      }

      // Include company logo if uploaded
      const logoImg = document.getElementById('logo-preview-img');
      if (logoImg.src && !logoImg.src.includes('assets/images/')) {
        profileData.companyLogo = logoImg.src;
      }

      // Include UPI QR code if uploaded
      const qrImg = document.getElementById('qr-preview-img');
      if (qrImg.src && qrImg.src.trim() !== '') {
        profileData.upiQrCode = qrImg.src;
      }

      try {
        await authManager.createUserProfile(authManager.currentUser.uid, profileData);
        alert('Profile updated successfully!');

        // Refresh navbar logo if it was updated
        await loadNavbarLogo();
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error saving profile: ' + error.message);
      }
    }

    // Invoice Creation Functionality
    let itemIndex = 1;
    let currentInvoice = null;

    // Initialize invoice functionality when create-invoice section becomes visible
    function initializeInvoiceForm() {
      const form = document.getElementById('invoice-form');
      const generateBtn = document.getElementById('generate-invoice');
      const downloadBtn = document.getElementById('download-pdf');
      const invoiceOutput = document.getElementById('invoice-output');
      const addItemBtn = document.getElementById('add-item-btn');
      const saveInvoiceBtn = document.getElementById('save-invoice');

      if (!form) return; // Form not ready yet

      // Add item functionality
      if (addItemBtn) {
        addItemBtn.removeEventListener('click', addNewItemHandler); // Remove existing listener
        addItemBtn.addEventListener('click', addNewItemHandler);
      }

      // Generate invoice functionality
      if (generateBtn) {
        generateBtn.removeEventListener('click', generateInvoiceHandler);
        generateBtn.addEventListener('click', generateInvoiceHandler);
      }

      // Download PDF functionality
      if (downloadBtn) {
        downloadBtn.removeEventListener('click', downloadPDFHandler);
        downloadBtn.addEventListener('click', downloadPDFHandler);
      }

      // New Invoice button functionality
      const newInvoiceBtn = document.getElementById('new-invoice-btn');
      if (newInvoiceBtn) {
        newInvoiceBtn.removeEventListener('click', startNewInvoiceHandler);
        newInvoiceBtn.addEventListener('click', startNewInvoiceHandler);
      }

      // Set default invoice date to today
      const invoiceDateField = document.getElementById('invoice-date');
      if (invoiceDateField && !invoiceDateField.value) {
        invoiceDateField.value = new Date().toISOString().split('T')[0];
      }

      // Load default seller data, buyer data and setup form
      if (authManager && authManager.currentUser) {
        authManager.loadDefaultSellerData();
      }
      loadBuyerData();
      setupItemCalculations();
    }

    // Collect form data function
    function collectFormData() {
      const items = [];
      const itemRows = document.querySelectorAll('.item-row');

      itemRows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const productId = productSelect ? productSelect.value : '';
        const description = row.querySelector('.item-description').value;
        const hsn = row.querySelector('.item-hsn').value || '';
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const total = parseFloat(row.querySelector('.item-total').value) || 0;

        if (description && quantity > 0 && price >= 0) {
          const item = { description, hsn, quantity, price, total };
          if (productId) {
            item.productId = productId;
          }
          items.push(item);
        }
      });

      return {
        seller: {
          name: document.getElementById('seller-name').value,
          address: document.getElementById('seller-address').value,
          gst: document.getElementById('seller-gst').value
        },
        buyer: {
          name: document.getElementById('buyer-name').value,
          address: document.getElementById('buyer-address').value,
          gst: document.getElementById('buyer-gst').value
        },
        items: items,
        customInvoiceNumber: document.getElementById('invoice-number').value.trim(),
        customDate: document.getElementById('invoice-date').value
      };
    }

    // Validate form data function
    function validateFormData(data) {
      if (!data.seller.name) {
        alert('Please enter seller name');
        return false;
      }
      if (!data.buyer.name) {
        alert('Please enter buyer name');
        return false;
      }
      if (!data.customDate) {
        alert('Please select invoice date');
        return false;
      }
      if (data.items.length === 0) {
        alert('Please add at least one item');
        return false;
      }
      return true;
    }

    // Display invoice function
    function displayInvoice(invoice) {
      const detailsElement = document.getElementById('invoice-details');

      let itemsHtml = '';
      invoice.items.forEach(item => {
        itemsHtml += `
          <tr>
            <td>${item.description}${item.hsn ? `<br><small>HSN: ${item.hsn}</small>` : ''}</td>
            <td class="text-right">${item.quantity}</td>
            <td class="text-right">‚Çπ${item.price.toFixed(2)}</td>
            <td class="text-right">‚Çπ${item.total.toFixed(2)}</td>
          </tr>
        `;
      });

      detailsElement.innerHTML = `
        <div class="invoice-preview">
          <div class="invoice-header">
            ${invoice.seller.logo ? `<div class="invoice-logo"><img src="${invoice.seller.logo}" alt="Company Logo"></div>` : ''}
            <h2>GST INVOICE</h2>
            <p>Invoice #: ${invoice.invoiceNumber}</p>
            <p>Date: ${invoice.date}</p>
          </div>
          
          <div class="invoice-details-grid">
            <div class="invoice-section">
              <h3>Seller Details:</h3>
              <p><strong>Name:</strong> ${invoice.seller.name}</p>
              ${invoice.seller.address ? `<p><strong>Address:</strong> ${invoice.seller.address}</p>` : ''}
              ${invoice.seller.gst ? `<p><strong>GST Number:</strong> ${invoice.seller.gst}</p>` : ''}
            </div>
            
            <div class="invoice-section">
              <h3>Buyer Details:</h3>
              <p><strong>Name:</strong> ${invoice.buyer ? invoice.buyer.name || 'N/A' : 'N/A'}</p>
              ${invoice.buyer && invoice.buyer.address ? `<p><strong>Address:</strong> ${invoice.buyer.address}</p>` : ''}
              ${invoice.buyer && invoice.buyer.gst ? `<p><strong>GST Number:</strong> ${invoice.buyer.gst}</p>` : ''}
            </div>
          </div>
          
          <table class="items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th class="text-right">Quantity</th>
                <th class="text-right">Unit Price</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>
          
          <div class="amount-section">
            <div class="amount-row">
              <span>Subtotal:</span>
              <span>‚Çπ${invoice.subtotal.toFixed(2)}</span>
            </div>
            <div class="amount-row">
              <span>CGST (2.5%):</span>
              <span>‚Çπ${(invoice.cgstAmount || 0).toFixed(2)}</span>
            </div>
            <div class="amount-row">
              <span>SGST (2.5%):</span>
              <span>‚Çπ${(invoice.sgstAmount || 0).toFixed(2)}</span>
            </div>
            <div class="amount-row">
              <span>Total GST:</span>
              <span>‚Çπ${(invoice.totalGstAmount || 0).toFixed(2)}</span>
            </div>
            <div class="amount-row total-amount">
              <span>Total Amount:</span>
              <span>‚Çπ${(invoice.totalAmount || 0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `;
    }

    function addNewItemHandler(e) {
      e.preventDefault();
      addNewItem();
    }

    async function generateInvoiceHandler(e) {
      e.preventDefault();
      const invoiceData = collectFormData();

      if (!validateFormData(invoiceData)) {
        return;
      }

      // Check stock availability for products
      for (const item of invoiceData.items) {
        if (item.productId) {
          const stockCheck = stockManager.checkStockAvailability(item.productId, item.quantity);
          if (!stockCheck.available) {
            alert(`Stock Error: ${stockCheck.message}`);
            return;
          }
        }
      }

      // Get company logo and add it to seller data
      const companyLogo = window.authManager ? await window.authManager.getCompanyLogo() : 'assets/images/logo.png';
      invoiceData.seller.logo = companyLogo;

      // Add custom invoice number and date if provided
      const customInvoiceNumber = document.getElementById('invoice-number').value.trim();
      const customDate = document.getElementById('invoice-date').value;
      invoiceData.customInvoiceNumber = customInvoiceNumber;
      invoiceData.customDate = customDate;

      const invoice = generateInvoice(invoiceData);

      // Auto-save invoice and process stock
      try {
        // Save invoice first
        const invoiceId = await invoiceStorage.saveInvoice(invoice);
        console.log('Invoice auto-saved with ID:', invoiceId);

        // Process stock deduction
        const stockResult = await stockManager.processInvoiceItems(invoiceData.items);
        if (!stockResult.success) {
          console.error('Stock processing failed:', stockResult.message);
          alert('Warning: Invoice saved but stock update failed: ' + stockResult.message);
        } else {
          console.log('Stock processed successfully');
        }

        // Save buyer data if it doesn't exist
        const buyerData = {
          name: invoiceData.buyer.name,
          address: invoiceData.buyer.address,
          gst: invoiceData.buyer.gst
        };

        if (buyerData.name && authManager?.currentUser) {
          await buyerStorage.saveBuyer(buyerData);
        }

        // Add invoice ID to current invoice for reference
        currentInvoice = { invoiceData, invoice: { ...invoice, id: invoiceId } };

      } catch (error) {
        console.error('Error auto-saving invoice:', error);
        alert('Error saving invoice: ' + error.message);
        return;
      }

      displayInvoice(invoice);

      const invoiceOutput = document.getElementById('invoice-output');
      invoiceOutput.classList.remove('hidden');

      // Scroll to the generated invoice
      setTimeout(() => {
        invoiceOutput.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }, 100);
    }

    async function downloadPDFHandler(e) {
      e.preventDefault();

      if (!currentInvoice) {
        alert('Please generate an invoice first');
        return;
      }

      await generateInvoicePDF(currentInvoice.invoice);

      // Refresh saved invoices list if we're on that tab
      const savedInvoicesSection = document.getElementById('saved-invoices');
      if (!savedInvoicesSection.classList.contains('hidden')) {
        loadSavedInvoices();
      }
    }



    function loadBuyerData() {
      const buyerSelect = document.getElementById('buyer-select');
      if (!buyerSelect || !authManager?.currentUser) {
        console.log('Cannot load buyer data:', {
          buyerSelect: !!buyerSelect,
          currentUser: !!authManager?.currentUser
        });
        return;
      }

      console.log('Loading buyer data...');
      buyerStorage.getAllBuyers().then(result => {
        console.log('Buyer data result:', result);
        buyerSelect.innerHTML = '<option value="">-- Select a buyer or enter new details --</option>';

        if (result.success && result.buyers && Array.isArray(result.buyers)) {
          result.buyers.forEach(buyer => {
            const option = document.createElement('option');
            option.value = JSON.stringify(buyer);
            option.textContent = `${buyer.name}${buyer.gst ? ` (${buyer.gst})` : ''}`;
            buyerSelect.appendChild(option);
          });
        } else {
          console.log('No buyers found or error loading buyers:', result);
        }

        // Remove existing event listener to avoid duplicates
        buyerSelect.removeEventListener('change', buyerSelectHandler);
        buyerSelect.addEventListener('change', buyerSelectHandler);
      }).catch(error => {
        console.error('Error loading buyers:', error);
      });
    }

    function buyerSelectHandler() {
      if (this.value) {
        const buyer = JSON.parse(this.value);
        document.getElementById('buyer-name').value = buyer.name || '';
        document.getElementById('buyer-address').value = buyer.address || '';
        document.getElementById('buyer-gst').value = buyer.gst || '';
      }
    }

    // Function to calculate item total
    function calculateItemTotal(itemRow) {
      const quantityInput = itemRow.querySelector('.item-quantity');
      const priceInput = itemRow.querySelector('.item-price');
      const totalInput = itemRow.querySelector('.item-total');

      const quantity = parseFloat(quantityInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const total = quantity * price;
      totalInput.value = total.toFixed(2);
      updateTotals();
    }

    // Function to update all totals
    function updateTotals() {
      const itemTotals = document.querySelectorAll('.item-total');
      let subtotal = 0;

      itemTotals.forEach(totalInput => {
        subtotal += parseFloat(totalInput.value) || 0;
      });

      const cgstAmount = subtotal * 0.025; // 2.5% CGST
      const sgstAmount = subtotal * 0.025; // 2.5% SGST
      const totalGstAmount = cgstAmount + sgstAmount;
      const grandTotal = subtotal + totalGstAmount;

      document.getElementById('subtotal-display').textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById('gst-display').textContent = `‚Çπ${totalGstAmount.toFixed(2)} (CGST: ‚Çπ${cgstAmount.toFixed(2)} + SGST: ‚Çπ${sgstAmount.toFixed(2)})`;
      document.getElementById('grand-total-display').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
    }

    // Function to calculate grand total (alias for updateTotals)
    function calculateGrandTotal() {
      updateTotals();
    }

    // Global item index for new items (declared earlier in script)

    // Add new item function
    function addNewItem() {
      const container = document.getElementById('items-container');
      const newItem = createItemRow(itemIndex);
      container.appendChild(newItem);
      itemIndex++;
      setupItemCalculations();
    }

    // Create item row function
    function createItemRow(index) {
      const itemRow = document.createElement('div');
      itemRow.className = 'item-row';
      itemRow.setAttribute('data-index', index);

      itemRow.innerHTML = `
        <div class="item-fields">
          <div class="field-group">
            <label>Select Product (Optional):</label>
            <select class="product-select">
              <option value="">-- Select from inventory or enter manually --</option>
            </select>
          </div>
          <div class="field-group">
            <label>Item Description:</label>
            <input type="text" class="item-description" placeholder="Enter item description" required>
          </div>
          <div class="field-group">
            <label>HSN Code:</label>
            <input type="text" class="item-hsn" placeholder="HSN Code (Optional)">
          </div>
          <div class="field-group">
            <label>Quantity:</label>
            <input type="number" class="item-quantity" min="1" step="0.01" value="1" required>
          </div>
          <div class="field-group">
            <label>Unit Price (‚Çπ):</label>
            <input type="number" class="item-price" min="0" step="0.01" placeholder="0.00" required>
          </div>
          <div class="field-group">
            <label>Total (‚Çπ):</label>
            <input type="number" class="item-total" readonly>
          </div>
          <div class="field-group">
            <button type="button" class="remove-item-btn" onclick="removeItem(${index})">Remove</button>
          </div>
        </div>
      `;

      return itemRow;
    }

    // Remove item function - make it global
    window.removeItem = function (index) {
      const itemRow = document.querySelector(`[data-index="${index}"]`);
      if (itemRow) {
        itemRow.remove();
        updateTotals();
      }

      // Prevent removing the last item
      const remainingItems = document.querySelectorAll('.item-row');
      if (remainingItems.length === 0) {
        addNewItem();
      }
    }

    // Start new invoice handler
    function startNewInvoiceHandler(e) {
      e.preventDefault();

      if (confirm('Are you sure you want to start a new invoice? Any unsaved changes will be lost.')) {
        // Reset the form
        document.getElementById('invoice-form').reset();

        // Reset invoice number and set today's date
        document.getElementById('invoice-number').value = '';
        document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];

        // Hide invoice output
        document.getElementById('invoice-output').classList.add('hidden');

        // Reset totals
        document.getElementById('subtotal-display').textContent = '‚Çπ0.00';
        document.getElementById('gst-display').textContent = '‚Çπ0.00';
        document.getElementById('grand-total-display').textContent = '‚Çπ0.00';

        // Reset items - keep only one item row
        const itemsContainer = document.getElementById('items-container');
        itemsContainer.innerHTML = `
          <div class="item-row" data-index="0">
            <div class="item-fields">
              <div class="field-group">
                <label>Item Description:</label>
                <input type="text" class="item-description" placeholder="Enter item description" required>
              </div>
              <div class="field-group">
                <label>HSN Code:</label>
                <input type="text" class="item-hsn" placeholder="HSN Code (Optional)">
              </div>
              <div class="field-group">
                <label>Quantity:</label>
                <input type="number" class="item-quantity" min="1" step="0.01" placeholder="1" required>
              </div>
              <div class="field-group">
                <label>Unit Price (‚Çπ):</label>
                <input type="number" class="item-price" min="0" step="0.01" placeholder="0.00" required>
              </div>
              <div class="field-group">
                <label>Total (‚Çπ):</label>
                <input type="number" class="item-total" readonly>
              </div>
              <div class="field-group">
                <button type="button" class="remove-item-btn" onclick="removeItem(0)">Remove</button>
              </div>
            </div>
          </div>
        `;

        // Reset item index
        itemIndex = 1;

        // Clear current invoice
        currentInvoice = null;

        // Load default seller data again
        if (authManager && authManager.currentUser) {
          authManager.loadDefaultSellerData();
        }

        // Scroll back to top of form
        document.getElementById('create-invoice-section').scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    // Function to switch to create invoice section from "create your first invoice" link
    function switchToCreateInvoice() {
      // Remove active class from all menu items and sections
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));

      // Activate create invoice menu item and section
      const createInvoiceMenuItem = document.querySelector('[data-section="create-invoice-section"]');
      const createInvoiceSection = document.getElementById('create-invoice-section');

      if (createInvoiceMenuItem) createInvoiceMenuItem.classList.add('active');
      if (createInvoiceSection) createInvoiceSection.classList.remove('hidden');

      // Initialize the invoice form
      setTimeout(initializeInvoiceForm, 100);
    }

    // Stock Management Functions
    function initStockManagement() {
      // Stock tab functionality
      const stockTabButtons = document.querySelectorAll('.stock-tabs .tab-btn');
      const stockTabContents = document.querySelectorAll('#stock-management-section .tab-content');

      stockTabButtons.forEach(button => {
        button.addEventListener('click', function () {
          const targetTab = this.getAttribute('data-tab');

          // Remove active class from all tabs and contents
          stockTabButtons.forEach(btn => btn.classList.remove('active'));
          stockTabContents.forEach(content => content.classList.remove('active'));

          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
        });
      });

      // Product form submission
      document.getElementById('product-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        await saveProductData();
      });

      // Refresh products button
      document.getElementById('refresh-products').addEventListener('click', function () {
        loadProducts();
      });

      // Export products button (placeholder)
      document.getElementById('export-products').addEventListener('click', function () {
        exportProducts();
      });
    }

    async function saveProductData() {
      const form = document.getElementById('product-form');
      const isEditing = form.hasAttribute('data-edit-id');
      const editId = form.getAttribute('data-edit-id');

      const productData = {
        name: document.getElementById('product-name').value.trim(),
        description: document.getElementById('product-description').value.trim(),
        hsn: document.getElementById('product-hsn').value.trim(),
        price: parseFloat(document.getElementById('product-price').value) || 0,
        stock: parseInt(document.getElementById('product-stock').value) || 0,
        unit: document.getElementById('product-unit').value,
        category: document.getElementById('product-category').value.trim()
      };

      if (!productData.name) {
        alert('Please enter product name');
        return;
      }

      if (!productData.unit) {
        alert('Please select unit of measurement');
        return;
      }

      try {
        let result;
        if (isEditing) {
          result = await stockManager.updateProduct(editId, productData);
        } else {
          result = await stockManager.addProduct(productData);
        }

        if (result.success) {
          alert(isEditing ? 'Product updated successfully!' : 'Product added successfully!');

          // Reset form
          form.reset();
          form.removeAttribute('data-edit-id');
          form.querySelector('button[type="submit"]').textContent = 'Add Product';

          // Switch back to products tab
          document.querySelector('[data-tab="products-tab"]').click();

          // Refresh products list
          loadProducts();

          // Refresh product dropdowns in invoice form
          loadProductsInDropdowns();
        } else {
          alert('Error saving product: ' + result.message);
        }
      } catch (error) {
        console.error('Error saving product:', error);
        alert('Error saving product: ' + error.message);
      }
    }

    async function loadProductsInDropdowns() {
      const result = await stockManager.getProducts();
      if (result.success) {
        const productSelects = document.querySelectorAll('.product-select');

        productSelects.forEach(select => {
          // Clear existing options except the first one
          const firstOption = select.querySelector('option[value=""]');
          select.innerHTML = '';
          select.appendChild(firstOption);

          // Add product options
          result.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (Stock: ${product.stock || 0}) - ‚Çπ${(product.price || 0).toFixed(2)}`;
            option.setAttribute('data-product', JSON.stringify(product));
            select.appendChild(option);
          });
        });

        // Add change event listeners to product selects
        productSelects.forEach(select => {
          select.removeEventListener('change', handleProductSelection);
          select.addEventListener('change', handleProductSelection);
        });
      }
    }

    function handleProductSelection(e) {
      const select = e.target;
      const itemRow = select.closest('.item-row');

      if (select.value) {
        const productData = JSON.parse(select.getAttribute('data-product') || select.options[select.selectedIndex].getAttribute('data-product'));

        if (productData) {
          // Auto-fill product details
          itemRow.querySelector('.item-description').value = productData.name;
          itemRow.querySelector('.item-hsn').value = productData.hsn || '';
          itemRow.querySelector('.item-price').value = productData.price || 0;

          // Calculate total
          calculateItemTotal(itemRow);

          // Add stock warning if needed
          addStockWarning(itemRow, productData);
        }
      } else {
        // Clear auto-filled data
        itemRow.querySelector('.item-description').value = '';
        itemRow.querySelector('.item-hsn').value = '';
        itemRow.querySelector('.item-price').value = '';
        itemRow.querySelector('.item-total').value = '';

        // Remove stock warnings
        removeStockWarning(itemRow);

        updateTotals();
      }
    }

    function addStockWarning(itemRow, productData) {
      // Remove existing warnings
      removeStockWarning(itemRow);

      const quantityInput = itemRow.querySelector('.item-quantity');
      const quantity = parseFloat(quantityInput.value) || 0;
      const availableStock = productData.stock || 0;

      let warningDiv = null;

      if (availableStock === 0) {
        warningDiv = document.createElement('div');
        warningDiv.className = 'stock-error';
        warningDiv.textContent = 'Product is out of stock!';
      } else if (quantity > availableStock) {
        warningDiv = document.createElement('div');
        warningDiv.className = 'stock-error';
        warningDiv.textContent = `Insufficient stock! Available: ${availableStock}`;
      } else if (availableStock <= 10) {
        warningDiv = document.createElement('div');
        warningDiv.className = 'stock-warning';
        warningDiv.textContent = `Low stock warning! Available: ${availableStock}`;
      }

      if (warningDiv) {
        quantityInput.parentNode.appendChild(warningDiv);
      }
    }

    function removeStockWarning(itemRow) {
      const warnings = itemRow.querySelectorAll('.stock-warning, .stock-error');
      warnings.forEach(warning => warning.remove());
    }

    function exportProducts() {
      // Placeholder for export functionality
      alert('Export functionality will be implemented in future updates');
    }

    // Update setupItemCalculations to include stock warnings
    function setupItemCalculations() {
      // Add event listeners for item calculations
      document.addEventListener('input', function (e) {
        if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
          const itemRow = e.target.closest('.item-row');
          if (itemRow) {
            calculateItemTotal(itemRow);
            calculateGrandTotal();

            // Check stock availability if product is selected
            const productSelect = itemRow.querySelector('.product-select');
            if (productSelect && productSelect.value) {
              const selectedOption = productSelect.options[productSelect.selectedIndex];
              const productData = JSON.parse(selectedOption.getAttribute('data-product') || '{}');
              if (productData.id) {
                addStockWarning(itemRow, productData);
              }
            }
          }
        }
      });
    }

    // Override section switching to initialize invoice form when needed
    const originalMenuClick = document.querySelector('.menu').addEventListener;
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function (e) {
        const section = this.getAttribute('data-section');
        if (section === 'create-invoice-section') {
          // Small delay to ensure DOM is updated
          setTimeout(() => {
            initializeInvoiceForm();
            loadProductsInDropdowns();
          }, 100);
        }
      });
    });
  </script>
</body>

</html>